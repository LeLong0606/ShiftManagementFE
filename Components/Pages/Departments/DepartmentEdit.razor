@page "/departments/add"
@page "/departments/edit/{Id:int}"
@using ShiftManagementFE.DTOs
@using ShiftManagementFE.Services
@inject DepartmentService DepartmentService
@inject NavigationManager Navigation

<h3>@(IsEdit ? "Cập nhật phòng ban" : "Thêm phòng ban")</h3>

<EditForm Model="Model" OnValidSubmit="OnValidSubmit">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="mb-3">
        <label class="form-label">Tên phòng ban</label>
        <InputText class="form-control" @bind-Value="Model.DepartmentName" />
    </div>
    <div class="mb-3">
        <label class="form-label">Cửa hàng (ID)</label>
        <InputNumber class="form-control" @bind-Value="Model.StoreID" />
    </div>
    <div class="mb-3">
        <label class="form-label">Quản lý (ID)</label>
        <InputNumber class="form-control" @bind-Value="Model.ManagerID" />
    </div>
    <button class="btn btn-primary" type="submit">Lưu</button>
    <button class="btn btn-secondary" type="button" @onclick="OnCancel">Hủy</button>
</EditForm>

@code {
    [Parameter] public int? Id { get; set; }
    public bool IsEdit => Id != null;

    // Dùng đúng DTO
    public DepartmentDto Model { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        if (IsEdit)
        {
            var d = await DepartmentService.GetDepartmentAsync(Id.Value);
            if (d != null)
            {
                Model = d;
            }
        }
        else
        {
            Model = new DepartmentDto();
        }
    }

    private async Task OnValidSubmit()
    {
        ApiResult result;
        if (!IsEdit)
        {
            var res = await DepartmentService.CreateDepartmentAsync(Model);
            result = new ApiResult(res.IsSuccess, res.Error);
        }
        else
        {
            result = await DepartmentService.UpdateDepartmentAsync(Id!.Value, Model);
        }

        if (result.IsSuccess)
        {
            Navigation.NavigateTo("/departments");
        }
        else
        {
            // TODO: Hiển thị lỗi nếu cần
        }
    }

    private void OnCancel()
    {
        Navigation.NavigateTo("/departments");
    }
}